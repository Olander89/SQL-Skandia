DROP TABLE #Faktinlaning_start_date
DROP TABLE #Faktinlaning_end_date
DROP TABLE #ALMM_C70_rolling_clients
DROP TABLE #ALMM_C70_new_clients
DROP TABLE #ALMM_C70_leaving_clients

SELECT *
INTO #Faktinlaning_start_date
FROM irrbb_dm.dbo.FactInlåning
WHERE Datum = '2020-09-07 00:00:00.000'

SELECT *
INTO #Faktinlaning_end_date
FROM irrbb_dm.dbo.FactInlåning
WHERE Datum = '2020-09-08 00:00:00.000'

--Rolling
SELECT 
t1.Datum,
t1.Kontonummer,
t1.EkonomiProduktID,
t1.SektorKod,
(t1.Saldo - t2.Saldo) AS Saldo_diff_0
INTO #ALMM_C70_rolling_clients
FROM #Faktinlaning_start_date AS t1
INNER JOIN #Faktinlaning_end_date AS t2
ON t1.Kontonummer = t2.kontonummer

--New clients
SELECT 
t1.Datum,
t1.Kontonummer,
t1.EkonomiProduktID,
t1.SektorKod,
t1.Saldo AS Saldo_diff_0
INTO #ALMM_C70_new_clients
FROM #Faktinlaning_end_date AS t1
LEFT JOIN #Faktinlaning_start_date AS t2
ON t1.Kontonummer = t2.kontonummer
WHERE t2.Kontonummer IS NULL

-- Leaving clients
SELECT 
t1.Datum,
t1.Kontonummer,
t1.EkonomiProduktID,
t1.SektorKod,
(0 - t1.Saldo) AS Saldo_diff_0
INTO #ALMM_C70_leaving_clients
FROM #Faktinlaning_start_date AS t1
LEFT JOIN #Faktinlaning_end_date AS t2
ON t1.Kontonummer = t2.kontonummer
WHERE t2.Kontonummer IS NULL

--Summeringar
SELECT
t1.Datum,
t1.EkonomiProduktID,
t1.SektorKod,
sum(t1.saldo_diff_0) as Total
FROM #ALMM_C70_rolling_clients t1
GROUP BY Datum, Kontonummer, EkonomiProduktID, SektorKod

UNION

SELECT
'2020-09-07 00:00:00.000',
t1.EkonomiProduktID,
t1.SektorKod,
sum(t1.saldo_diff_0) as Total
FROM #ALMM_C70_new_clients t1
GROUP BY Datum, Kontonummer, EkonomiProduktID, SektorKod

UNION

SELECT
'2020-09-07 00:00:00.000',
t1.EkonomiProduktID,
t1.SektorKod,
sum(t1.saldo_diff_0) as Total
FROM #ALMM_C70_leaving_clients t1
GROUP BY Datum, Kontonummer, EkonomiProduktID, SektorKod
